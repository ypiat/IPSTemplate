@page "/user"
@using IPSTemplate.BusinessLibrary.BO.Identity.User;

<IPSPageTop Title="Uporabniki" >
    <ActionsContent>
        <IPSButton IconClass="fas fa-plus" Color="Color.Primary" OnClick=NavigateToRegister>Dodaj uporabnika</IPSButton>
    </ActionsContent>
</IPSPageTop>

<UsersGrid EditClicked=OpenEditView @ref=_grid />

<IPSWindow Title=@_editViewTitle
           Size="WindowSize.Medium"
           ConfirmCloseWhen=@(() => _editView.ViewModel.Model.IsDirty)
            @bind-Visible=@windowVisible>
    <WindowContent>
        <UserEdit ItemId=@_selectedItemId ItemSaved=CloseEditView @ref=_editView />
    </WindowContent>
</IPSWindow>

@code {
    string? _selectedItemId;
    string? _editViewTitle;
    bool windowVisible;
    UsersGrid _grid = default!; 
    UserEdit _editView = default!;

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = default!;

    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var user = (await authenticationStateTask).User;

        if (user.Identity?.IsAuthenticated == false || user.IsInRole("Member"))
        {
            NavigationManager.NavigateTo("/");
        }
    }

    protected void NavigateToRegister()
    {
        NavigationManager.NavigateTo("/account/register");
    }

    protected void OpenEditView(TEUserInfo? selectedItem)
    {
        _editViewTitle = $"Uredi uporabnika - {selectedItem.DisplayNameLong}";
        _selectedItemId = selectedItem.Id.ToString();
        windowVisible = true;
    }

    async Task CloseEditView()
    {
        await Task.Delay(1000);
        windowVisible = false;
        _selectedItemId = null;
        _grid.Rebind();
    }
}
